name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Package binaries
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # Create release directory
          mkdir -p release

          # Create standalone installer that downloads from this release
          cat > release/install.sh <<'INSTALLER_EOF'
          #!/bin/bash
          # Claude-Vault Standalone Installer
          # Downloads and installs claude-vault from GitHub releases

          set -e

          GITHUB_REPO="weber8thomas/claude-vault"
          VERSION="${CLAUDE_VAULT_VERSION:-latest}"
          PREFIX="${PREFIX:-/usr/local/bin}"

          echo "Installing claude-vault ${VERSION} to ${PREFIX}..."

          # Check if we have write permission
          if [ ! -w "$PREFIX" ]; then
              echo "Error: No write permission to $PREFIX"
              echo "Please run with sudo or set PREFIX to a writable location:"
              echo "  sudo bash install.sh"
              echo "  PREFIX=\$HOME/.local/bin bash install.sh"
              exit 1
          fi

          # Determine latest version if not specified
          if [ "$VERSION" = "latest" ]; then
              echo "Fetching latest release version..."
              VERSION=$(curl -fsSL "https://api.github.com/repos/${GITHUB_REPO}/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
              echo "Latest version: ${VERSION}"
          fi

          # Download from GitHub release
          echo "Downloading claude-vault ${VERSION}..."
          TEMP_DIR=$(mktemp -d)
          trap "rm -rf $TEMP_DIR" EXIT

          curl -fsSL "https://github.com/${GITHUB_REPO}/releases/download/${VERSION}/claude-vault-${VERSION}-linux-amd64.tar.gz" | tar -xz -C "$TEMP_DIR"

          # Install scripts
          echo "Installing scripts to ${PREFIX}..."
          cp -v "$TEMP_DIR/claude-vault/packages/cli/"* "${PREFIX}/"

          # Make executable
          echo "Setting permissions..."
          chmod +x "${PREFIX}"/claude-vault*
          chmod +x "${PREFIX}"/vault-*
          chmod +x "${PREFIX}"/inject-secrets.sh

          echo ""
          echo "âœ… Installation complete!"
          echo ""
          echo "claude-vault ${VERSION} is now available in your PATH."
          echo "Try: claude-vault --help"
          INSTALLER_EOF

          chmod +x release/install.sh

          # Create tarball
          tar -czf release/claude-vault-${VERSION}-linux-amd64.tar.gz \
            --transform 's,^,claude-vault/,' \
            packages/cli/ docs/ install.sh README.md LICENSE

          # Create zip
          zip -r release/claude-vault-${VERSION}-linux-amd64.zip \
            packages/cli/ docs/ install.sh README.md LICENSE

          # Create checksums
          cd release
          sha256sum *.tar.gz *.zip install.sh > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release/*.tar.gz
            release/*.zip
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
